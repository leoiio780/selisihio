<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alat Rekonsiliasi Data (Perbandingan ID)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .textarea-data {
            width: 100%;
            height: 250px;
            padding: 12px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            background-color: #f9fafb;
            font-family: monospace;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .textarea-data:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        thead th {
            background-color: #f3f4f6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Custom styles untuk status */
        .status-sesuai { background-color: #dcfce7; color: #166534; }
        .status-selisih { background-color: #fef9c3; color: #854d0e; }
        .status-tidak-ditemukan { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-6 md:p-8">

    <div class="max-w-screen-xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Alat Rekonsiliasi Data Massal</h1>
            <p class="mt-2 text-lg text-gray-600">Bandingkan ID dan nominal berdampingan untuk validasi yang akurat.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-2">1. Tempel Data Sistem (Panel)</h2>
                    <p class="text-sm text-gray-500 mb-4">Salin 2 kolom (ID dan Nominal) dari Excel lalu tempel di sini.</p>
                    <textarea id="sistem-data" class="textarea-data" placeholder="Contoh:&#10;123ad   50000&#10;456ef   75000&#10;789gh   20000&#10;123ad   50000  (ID Duplikat contoh)"></textarea>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-2">2. Tempel Data Catatan Manual</h2>
                    <p class="text-sm text-gray-500 mb-4">Salin 2 kolom (ID dan Nominal) dari Excel lalu tempel di sini.</p>
                    <textarea id="manual-data" class="textarea-data" placeholder="Contoh:&#10;123AD   49000  (salah nominal)&#10;456ef   75000  (sesuai)&#10;101ij   15000  (hanya di manual)&#10;123AD   50000  (ID Duplikat contoh)"></textarea>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">3. Hasil Rekonsiliasi Otomatis</h2>
                <div class="overflow-auto" style="max-height: 600px;">
                    <table class="w-full text-sm">
                        <thead>
                            <tr>
                                <th class="p-2 text-left">ID Sistem</th>
                                <th class="p-2 text-left">ID Manual</th>
                                <th class="p-2 text-left">Nominal Sistem</th>
                                <th class="p-2 text-left">Nominal Manual</th>
                                <th class="p-2 text-left">Selisih</th>
                                <th class="p-2 text-left">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="hasil-rekon">
                           <tr><td colspan="6" class="text-center p-8 text-gray-500">Silakan tempel data di kolom sebelah kiri untuk melihat hasilnya.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fungsi untuk memformat angka menjadi format Rupiah
        function formatRupiah(angka) {
            if (typeof angka === 'undefined' || angka === null || isNaN(angka)) {
                return '-';
            }
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(angka);
        }
        
        // FUNGSI parseData DIUBAH: Sekarang mengembalikan array dari semua baris yang ditemukan
        // Setiap baris akan berisi originalId, normalizedId, dan nominal.
        function parseData(text) {
            const dataList = []; // Menggunakan array untuk menyimpan semua entri, termasuk duplikat
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            lines.forEach(line => {
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 2) {
                    const originalId = parts[0];
                    const normalizedId = originalId.toLowerCase();
                    const nominal = parseFloat(parts[parts.length - 1].replace(/,/g, ''));
                    if (normalizedId && !isNaN(nominal)) {
                        dataList.push({ originalId: originalId, normalizedId: normalizedId, nominal: nominal });
                    }
                }
            });
            return dataList;
        }

        // Fungsi utama untuk melakukan rekonsiliasi
        function reconcileData() {
            const sistemDataText = document.getElementById('sistem-data').value;
            const manualDataText = document.getElementById('manual-data').value;
            
            // Sekarang kita mendapatkan array dari parseData
            const sistemDataList = parseData(sistemDataText);
            const manualDataList = parseData(manualDataText);

            const hasilBody = document.getElementById('hasil-rekon');
            hasilBody.innerHTML = ''; // Kosongkan tabel hasil

            // Membuat Map untuk pencarian cepat, mengizinkan duplikat di sumber yang sama
            // Kita akan menyimpan ARRAY dari objek di setiap kunci normalizedId
            const sistemDataMap = new Map();
            sistemDataList.forEach(item => {
                if (!sistemDataMap.has(item.normalizedId)) {
                    sistemDataMap.set(item.normalizedId, []);
                }
                sistemDataMap.get(item.normalizedId).push(item);
            });

            const manualDataMap = new Map();
            manualDataList.forEach(item => {
                if (!manualDataMap.has(item.normalizedId)) {
                    manualDataMap.set(item.normalizedId, []);
                }
                manualDataMap.get(item.normalizedId).push(item);
            });

            // Mengumpulkan semua ID unik dari kedua sumber untuk menentukan baris hasil
            const allNormalizedIds = new Set([...sistemDataMap.keys(), ...manualDataMap.keys()]);

            if (allNormalizedIds.size === 0 && sistemDataList.length === 0 && manualDataList.length === 0) {
                 hasilBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Tempel data untuk memulai.</td></tr>`;
                 return;
            }
            
            // Mengelola entri yang "Hanya di Sistem" atau "Hanya di Manual"
            // Ini penting karena jika ada duplikat dalam satu sumber, kita ingin menampilkannya
            let processedIds = new Set(); // Untuk melacak ID yang sudah diproses di kedua sisi

            // 1. Proses ID yang ada di sistem (termasuk duplikat internal)
            sistemDataList.forEach(sistemItem => {
                const normalizedId = sistemItem.normalizedId;
                if (!processedIds.has(`sistem_${normalizedId}_${sistemItem.nominal}`)) { // Hindari memproses entri yang sama persis lebih dari sekali jika ada duplikat di kedua sisi
                    const manualEntries = manualDataMap.get(normalizedId);
                    
                    if (manualEntries && manualEntries.length > 0) {
                        // Coba cari pasangan yang nominalnya sama persis
                        let foundMatch = false;
                        for (let i = 0; i < manualEntries.length; i++) {
                            const manualItem = manualEntries[i];
                            if (sistemItem.nominal === manualItem.nominal) {
                                appendRow(sistemItem, manualItem, 'Sesuai', 'status-sesuai');
                                processedIds.add(`sistem_${sistemItem.normalizedId}_${sistemItem.nominal}`);
                                processedIds.add(`manual_${manualItem.normalizedId}_${manualItem.nominal}`);
                                // Hapus manualItem dari array agar tidak diproses lagi
                                manualEntries.splice(i, 1); 
                                foundMatch = true;
                                break;
                            }
                        }
                        if (!foundMatch) {
                            // Jika tidak ada match nominal, ambil entri manual pertama yang belum diproses untuk ditampilkan selisih
                            const manualItemToCompare = manualEntries.shift(); // Ambil dan hapus yang pertama
                            if (manualItemToCompare) {
                                const selisih = sistemItem.nominal - manualItemToCompare.nominal;
                                appendRow(sistemItem, manualItemToCompare, 'Ada Selisih', 'status-selisih', selisih);
                                processedIds.add(`sistem_${sistemItem.normalizedId}_${sistemItem.nominal}`);
                                processedIds.add(`manual_${manualItemToCompare.normalizedId}_${manualItemToCompare.nominal}`);
                            } else {
                                // Ini kasus di mana semua manual entries untuk ID ini sudah terpakai
                                appendRow(sistemItem, null, 'Hanya di Sistem', 'status-tidak-ditemukan');
                                processedIds.add(`sistem_${sistemItem.normalizedId}_${sistemItem.nominal}`);
                            }
                        }
                    } else {
                        // Hanya ada di sistem
                        appendRow(sistemItem, null, 'Hanya di Sistem', 'status-tidak-ditemukan');
                        processedIds.add(`sistem_${sistemItem.normalizedId}_${sistemItem.nominal}`);
                    }
                }
            });

            // 2. Proses ID yang tersisa di manualDataMap (yang belum dipasangkan)
            manualDataList.forEach(manualItem => {
                // Periksa apakah manualItem ini sudah diproses dari sisi sistem
                if (!processedIds.has(`manual_${manualItem.normalizedId}_${manualItem.nominal}`)) {
                    appendRow(null, manualItem, 'Hanya di Manual', 'status-tidak-ditemukan');
                    processedIds.add(`manual_${manualItem.normalizedId}_${manualItem.nominal}`);
                }
            });

            // Fungsi helper untuk menambahkan baris ke tabel
            function appendRow(sistemItem, manualItem, keterangan, statusClass, selisihOverride = null) {
                const idSistem = sistemItem ? sistemItem.originalId : '-';
                const idManual = manualItem ? manualItem.originalId : '-';

                const nominalSistem = sistemItem ? sistemItem.nominal : undefined;
                const nominalManual = manualItem ? manualItem.nominal : undefined;

                const selisih = selisihOverride !== null ? selisihOverride : ((nominalSistem || 0) - (nominalManual || 0));

                const newRow = `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2 font-medium ${!sistemItem ? 'text-gray-400' : ''}">${idSistem}</td>
                        <td class="p-2 font-medium ${!manualItem ? 'text-gray-400' : ''}">${idManual}</td>
                        <td class="p-2">${formatRupiah(nominalSistem)}</td>
                        <td class="p-2">${formatRupiah(nominalManual)}</td>
                        <td class="p-2 font-semibold ${selisih !== 0 ? 'text-red-600' : 'text-green-600'}">${formatRupiah(selisih)}</td>
                        <td class="p-2"><span class="px-2 py-1 rounded-full font-semibold text-xs ${statusClass}">${keterangan}</span></td>
                    </tr>
                `;
                hasilBody.innerHTML += newRow;
            }
        }

        // Tambahkan event listener ke kedua textarea
        document.getElementById('sistem-data').addEventListener('input', reconcileData);
        document.getElementById('manual-data').addEventListener('input', reconcileData);
    </script>
</body>
</html>
